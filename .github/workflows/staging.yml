name: react-native-android-build-apk
on:
  push:
    branches:
      - staging
jobs:
  install-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install npm dependencies
        run: |
          yarn install
#  build-android:
#    needs: install-and-test
#    runs-on: ubuntu-latest
#    steps: 
#      - uses: actions/checkout@v2
#      - name: Install npm dependencies
#        run: |
#          npm install
#      - name: Build Android Release
#        run: |
#          cd android && ./gradlew assembleRelease
#      - name: Upload Artifact
#        uses: actions/upload-artifact@v1
#        with:
#          name: app-release.apk
#          path: android/app/build/outputs/apk/release/
#      - name: Send mail
#        uses: dawidd6/action-send-mail@v3
#        with:
#          # Required mail server address:
#          server_address: xum.ibumu.com
#          # Required mail server port:
#          server_port: 465
#          # Required mail server username:
#          username: ${{secrets.MAIL_USERNAME}}
#          # Required mail server password:
#          password: ${{secrets.MAIL_PASSWORD}}
#          # Required mail subject:
#          subject: Github Actions job result
#          # Required recipients' addresses:
#          to: agustin@nefila.com.ar
#          # Required sender full name (address can be skipped):
#          from: The Glew # <user@example.com>
#          # Optional plain body:
#          body: Build job of ${{github.repository}} completed successfully!
#          # Optional unsigned/invalid certificates allowance:
#          ignore_cert: true
#          # Optional converting Markdown to HTML (set content_type to text/html too):
#          convert_markdown: false
#          # Optional attachments:
#          attachments: android/app/build/outputs/apk/release/app-release.apk
  build-ios:
    needs: install-and-test
    runs-on: [macos-latest]
    steps: 
      - uses: actions/checkout@v2
      - name: Install npm dependencies
        run: |
          yarn install
      - name: Decrypt Google Cloud Key
        run: sh ./scripts/ios-gpg-decrypt.sh
        env:
          ENCRYPT_PASSWORD: ${{ secrets.GPG_ENCRYPT_PASSWORD }}
      - name: Dump secrets to .env
        run: env > .env
        env:
          REQUIRED_ENV: ${{ secrets.REQUIRED_ENV }}
      - name: Build and Upload to TestFlight
        run: bundle exec fastlane build_and_release_to_app_store versionName:${{ github.event.release.tag_name }}
        env:
          VERSION_NAME: ${{ github.event.release.tag_name }}
          GITHUB_RUN_NUMBER: ${{ secrets.GITHUB_RUN_NUMBER }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}